$(document).ready(function () {
    loadIndexData();


    setTimeout(function () {
        setRandomBackgroundImg();
        initializeSlickSlider();
    }, 500);

});

async function loadIndexData() {
    const lang = getCurrentLang();

    const [reviews, indexTranslations] = await Promise.all(
        [
            loadTranslations('/assets/i18n/reviews.json', lang),
            loadTranslations('/assets/i18n/translations-index.json', lang)
        ]
    )


    if (indexTranslations) {
        $(".introTitle").text(indexTranslations.intro.title);
        $(".introContent").text(indexTranslations.intro.content);

        $("#businessEcosystemTitle").text(indexTranslations.businessEcosystem.title);
        $("#businessEcosystemContent").text(indexTranslations.businessEcosystem.content);

        $("#discoverTitle").text(indexTranslations.discover.title);
        $("#discoverContent").text(indexTranslations.discover.content);

        $("#paintingCostTitle").text(indexTranslations.paintingCost.title);
        $("#paintingCostContent").text(indexTranslations.paintingCost.content);

        $("#deskToPocketTitle").text(indexTranslations.deskToPocket.title);
        $("#deskToPocketContent").text(indexTranslations.deskToPocket.content);

        $("#faqTitle").text(indexTranslations.faq.title);
        $("#faqContent").text(indexTranslations.faq.content);

        // This will set dynamic content inside generated pages
        var city = $('#city').data('city');
        if (city) {
            let title = indexTranslations.paintersListPage.title.replace("%CITY%", city);
            let content = indexTranslations.paintersListPage.content.replace("%CITY%", city);

            $(".paintersListPageTitle").text(title);
            $(".paintersListPageContent").text(content);
        }

        $(".cityListPageTitle").text(indexTranslations.cityListPage.title);
        $(".cityListPageContent").text(indexTranslations.cityListPage.content);
    }

    
    if (reviews) {
        displayRandomReviews(reviews);

        setTimeout(() => {
            displayReviews(reviews);
        }, 2000);
    }

    setTimeout(async () => {
        const FAQs = await loadTranslations('/assets/i18n/FAQ.json', lang);
        if (FAQs) displayFAQs(FAQs);
    }, 3000);
}

async function setRandomBackgroundImg() {
    try {
        const response = await fetch(`/assets/images/banners/index.json`);
        const imagesList = await response.json();

        document.getElementById('hero-section').style.backgroundImage = `url(${imagesList.random(imagesList.length)})`;
    } catch (error) {
        document.getElementById('hero-section').style.backgroundImage = 'url("../assets/images/banners/banner-bg.webp")';
    }
}

function displayRandomReviews(reviews) {
    if (reviews.length < 3) return;

    // generate 2 indexes
    const index1 = Math.floor(Math.random() * reviews.length);
    let index2 = Math.floor(Math.random() * reviews.length);
    let index3 = Math.floor(Math.random() * reviews.length);

    while (index2 === index1) {
        index2 = Math.floor(Math.random() * reviews.length);
    }

    while (index3 === index1 || index3 === index2) {
        index3 = Math.floor(Math.random() * reviews.length);
    }

    const randomReviews = [reviews[index1], reviews[index2], reviews[index3]];
    const starTotal = 5;

    $("#heroSectionReviews").empty();

    const html = randomReviews.map((review, index) => {
        const starPercentage = (review.rating / starTotal) * 100;
        const starPercentageRounded = `${(Math.round(starPercentage / 10) * 10)}%`;

        if (window.innerWidth < 768 && index === 2) {
            return;
        }

      return `
      <div class="col-lg-4 col-md-12 col-sm-12 col-xs-12 position-relative">
  
      <!-- Content div -->
      <div class="review-content"> 
        <!-- Web view -->
        <div class="px-3 d-none d-lg-block">
          <div class="reviews-stars stars-outer">
            <div class="reviews-stars stars-inner" style="width: ${starPercentageRounded}" ></div>
          </div> - "<i>${review.review.length > 200 ? review.review.substring(0, 200) + '...' : review.review}</i>" <br> ${review.title}, ${review.name}.
        </div>
      </div>
  
      <!-- Mobile view -->
      ${index < 2 ? `<div class="d-sm-block d-xs-block d-md-none d-lg-none">
      <div class="stars-outer"> 
        <div class="stars-inner" style="width: ${starPercentageRounded}" ></div>
      </div> - "<i>${review.review.length > 40 ? review.review.substring(0, 40) + '...' : review.review}</i>" <br> ${review.title}, ${review.name}.
      </div>
  
      <!-- Tablet view -->
      <div class="d-none d-sm-none d-md-block d-lg-none">
        <div class="stars-outer"> 
          <div class="stars-inner" style="width: ${starPercentageRounded}" ></div>
        </div> - "<i>${review.review.length > 140 ? review.review.substring(0, 140) + '...' : review.review}</i>" <br> ${review.title}, ${review.name}.
      </div>`
                : ''}
      <!-- Vertical line -->
          ${index == 1 || index == 2 ? '<div class="col-lg-1 d-lg-block d-md-none d-sm-none d-xs-none vertical-line"></div>' : ''} 
      </div>
           ${index == 0 ? '<div class="horizontal-line col-sm-2 col-md-2 d-lg-none"> <hr /></div>' : ''}
      `
    }).join("");

    $("#heroSectionReviews").html(html);
}

function displayReviews(reviews) {
    let html = "";
    let delay = 200;
    $("#customerSlider").empty();
    reviews.forEach((review, index) => {
        html = `
           <div data-aos="fade-up" data-aos-duration="600" data-aos-delay="${delay}">
                  <div class="customer-unit">
                      <div class="customer-avatar">
                          <img loading="lazy" src=${review.image} width="180" height="180" alt="avatar" />
                      </div>
                      <h4>${review.name}</h4>
                      <p>${review.title}</p>
                      <h5>“${review.review}”</h5>
                  </div>
            </div>
  
        `
        delay += 100;
        $('#customerSlider').slick('slickAdd', html);
    })
    $('#customerSlider').fadeIn().slick('refresh');
}

function getCurrentLang() {
    let lang = "de";

    if ($("html").is(":lang(en-CH)")) {
        lang = "en";
    }

    if ($("html").is(":lang(it-CH)")) {
        lang = "it";
    }

    if ($("html").is(":lang(fr-CH)")) {
        lang = "fr";
    }
    return lang;
}

async function loadTranslations(url, lang) {
    try {
        const response = await fetch(url);
        const data = await response.json();
        const langData = data[lang];

        return langData;
    } catch (error) {
        console.error('Error:', error);
    }
}

function displayFAQs(FAQs) {
    let html = '';
    $("#FAQsAccordion").empty();

    FAQs.forEach((FAQ, index) => {
        html += `
            <div class="accordion-item ${index > 4 ? 'd-none' : ''}">
                <div class="accordion-header" id="faq-heading-${index}">
                    <div class="btn accordion-items" role="button" data-bs-toggle="collapse" data-bs-target="#faq-collapse-${index}" aria-expanded="false" aria-controls="faq-collapse-${index}">
                      ${FAQ.question}  <span class="accordion-icon"></span> 
                    </div>
                </div>
                <div class="accordion-collapse collapse" id="faq-collapse-${index}" aria-labelledby="faq-heading-${index}" data-bs-parent="#FAQsAccordion">
                    <div class="accordion-body">${FAQ.answer}</div>
                </div>
            </div>
      `
    })
    $("#FAQsAccordion").append(html);

}

function loadAllFAQs() {
    $(".FAQ .accordion-item").removeClass("d-none");
    $("#load-all-faqs").addClass("d-none");
}

async function calculatePrice() {
    try {
        const postalCode = $('#postalCode').val();
        if (postalCode.length < 4) return;

        $("#plzSearch").addClass("disabled");
        const requestObject = {
            flat_size: 120,
            nr_rooms: 3.5,
            ceiling_height: 2.4,
            walls: true,
            ceiling: true,
            postal_code: postalCode,
            smoking_room: false
        };

        const response = await axios.post("https://europe-west6-gm-b2b2c.cloudfunctions.net/price_calculator", requestObject);
        if (!response.data) return;

        $("#foundPainters").text(response.data.total_painters)

        $("#project-details-modal").modal("show");
        $("#plzSearch").removeClass("disabled");
    } catch (err) {
        console.error(err);
        $("#plzSearch").removeClass("disabled");
    }
}

function initializeSlickSlider(){ 
        // Customer Slick slider
        var customerSlider = $("#customerSlider");
        if (customerSlider.length > 0 && !customerSlider.hasClass('slick-initialized')) {
            $('#customerSlider').slick({
                lazyLoad: 'ondemand',
                infinite: false,
                speed: 300,
                slidesToShow: 3,
                slidesToScroll: 3,
                responsive: [{
                    breakpoint: 1024,
                    settings: {
                        slidesToShow: 2,
                        slidesToScroll: 2,
                        infinite: true,
                    }
                },
                {
                    breakpoint: 600,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                },
                {
                    breakpoint: 480,
                    settings: {
                        slidesToShow: 1,
                        slidesToScroll: 1
                    }
                }
    
                ]
            });
        }
}